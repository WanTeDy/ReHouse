var previewWidth=300,previewHeight=150,maxFileSize=10485760,selectedFiles={},queue=[],queue_plan=[],image=new Image,imgLoadHandler,isProcessing=!1,errorMsg,previewPhotoContainer=document.querySelector("#list"),processQueue_plan;previewPhotoContainer_plan=document.querySelector("#list_plan");$("input[type=file][id=files]").on("change",function(){for(var n,i=$(this)[0].files,t=0;t<i.length;t++)if(n=i[t],selectedFiles[n.name]==undefined){if(errorMsg=validateFile(n)){alert(errorMsg);return}selectedFiles[n.name]=n;queue.push(n)}$(this).val("");processQueue()});var validateFile=function(n){return n.type.match(/image\/(jpeg|jpg|png|gif)/)?n.size>maxFileSize?"Размер фотографии не должен превышать 10 Мб":void 0:"Фотография должна быть в формате jpg, png или gif"},listen=function(n,t,i){return n.addEventListener(t,i,!1)},processQueue=function(){var i;if(!isProcessing){if(queue.length==0){isProcessing=!1;return}isProcessing=!0;var t=queue.pop(),n=document.createElement("DIV"),r=document.createElement("A"),u=document.createElement("CANVAS"),f=u.getContext("2d");n.setAttribute("class","photo_");r.innerHTML="X";n.setAttribute("data-id",t.name);image.removeEventListener("load",imgLoadHandler,!1);imgLoadHandler=function(){f.drawImage(image,0,0,previewWidth,previewHeight);URL.revokeObjectURL(image.src);n.appendChild(u);isProcessing=!1;setTimeout(processQueue,200)};n.appendChild(r);previewPhotoContainer.appendChild(n);listen(image,"load",imgLoadHandler);image.src=URL.createObjectURL(t);i=new FileReader;i.readAsDataURL(t);i.onload=function(n){return function(t){$("#list").append('<input type="hidden" name="image" value="'+t.target.result+'" data-id="'+n.name+'">')}}(t)}};$(document).on("click","#list div a",function(){var n=$(this).parents("div").attr("data-id");selectedFiles[n]!=undefined&&delete selectedFiles[n];$(this).parents("div.photo_").remove();$('input[name^=image][data-id="'+n+'"]').remove()});$("input[type=file][id=files_plan]").on("change",function(){for(var n,i=$(this)[0].files,t=0;t<i.length;t++)if(n=i[t],selectedFiles[n.name]==undefined){if(errorMsg=validateFile(n)){alert(errorMsg);return}selectedFiles[n.name]=n;queue_plan.push(n)}$(this).val("");processQueue_plan()});processQueue_plan=function(){var i;if(!isProcessing){if(queue_plan.length==0){isProcessing=!1;return}isProcessing=!0;var t=queue_plan.pop(),n=document.createElement("DIV"),r=document.createElement("A"),u=document.createElement("CANVAS"),f=u.getContext("2d");n.setAttribute("class","photo_");r.innerHTML="X";n.setAttribute("data-id",t.name);image.removeEventListener("load",imgLoadHandler,!1);imgLoadHandler=function(){f.drawImage(image,0,0,previewWidth,previewHeight);URL.revokeObjectURL(image.src);n.appendChild(u);isProcessing=!1;setTimeout(processQueue,200)};n.appendChild(r);previewPhotoContainer_plan.appendChild(n);listen(image,"load",imgLoadHandler);image.src=URL.createObjectURL(t);i=new FileReader;i.readAsDataURL(t);i.onload=function(n){return function(t){$("#list").append('<input type="hidden" name="planimage" value="'+t.target.result+'" data-id="'+n.name+'">')}}(t)}};$(document).on("click","#list_plan div a",function(){var n=$(this).parents("div").attr("data-id");selectedFiles[n]!=undefined&&delete selectedFiles[n];$(this).parents("div.photo_").remove();$('input[name^=image_plan][data-id="'+n+'"]').remove()});